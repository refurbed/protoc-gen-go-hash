# protoc-gen-go-hash
protoc-gen-go-hash is a simple compiler plugin to protoc. It adds one method called `Hash` to the message struct. This is 
used to produce a deterministic hash out of the protocol buffer message.

## Background
At Refurbed we have a [caching system that supports A/B testing](https://www.refurbed.org/posts/refbwebd-cache/). 
Therefore, we have the need to cache protocol buffer messages. We cannot really get a hash of the actual protobuf binary 
data since the default serialization is [not deterministic](https://developers.google.com/protocol-buffers/docs/encoding#implications), 
neither can we hash the json marshalled object because objects are [unordered](https://datatracker.ietf.org/doc/html/rfc8259#section-4) 
collections of name/value pairs. So we are left with using [hashstructure](https://github.com/mitchellh/hashstructure).

## Prerequisites
* Go 1.19
* [Protocol Buffer Compiler](https://grpc.io/docs/protoc-installation/)
* [Go protocol Buffers plugin](https://github.com/protocolbuffers/protobuf-go)

## Usage

### Install
In order to install the protoc-gen-go-hash plugin to use it in your projects first run:
```bash
go install gitlab.com/refurbed-community/oss/protoc-gen-go-hash
```

Then import `hashstructure` dependency in your project:
```bash
go get github.com/mitchellh/hashstructure/v2
```

And finally generate the protobuf messages you require:
```bash
protoc --go_out=. --go-hash_out=. <your proto files>
```

### Local Development

First clone the repo.
 
Then build the protoc-gen-go-hash plugin:
```bash
go build ./cmd/protoc-gen-go-hash
```
And finally generate the example protobuf message:
```bash
protoc --plugin=protoc-gen-go-hash=./protoc-gen-go-hash --go_out=. --go_opt=paths=source_relative --go-hash_out=. --go-hash_opt=paths=source_relative example/example.proto
```

## Outcome

For the example protobuf file, the following two files will be created, `example.pb.go` and `example_hash.pb.go`:
```text
proto-gen-hash/
├─ example/
│  ├─ example.proto
│  ├─ example.pb.go
│  ├─ example_hash.pb.go
```

example.pb.go is the familiar code generated by the protoc go plugin. And then the `example_hash.pb.go` will look like this:
```go
// Code generated by protoc-gen-go-hash. DO NOT EDIT.

package example

import (
	"fmt"
	"github.com/mitchellh/hashstructure/v2"
)

func (x *Hello) Hash() (uint64, error) {
	if x == nil {
		return 0, fmt.Errorf("message is defined as nil")
	}
	return hashstructure.Hash(*x, hashstructure.FormatV2, nil)
}
```

Therefore, the following code:
```go
h := &example.Hello{}
h.CustomerId = "1234"
fmt.Println(h.Hash())
```

prints out:
```text
10958536349413352795 <nil>
```
